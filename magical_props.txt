--@name Magical Props
--@author PrikolMen#3372
--@server

chip():setNoDraw(true)

local model_list = {
    "models/props_interiors/pot01a.mdl",
    "models/props_junk/metal_paintcan001a.mdl",
    //"models/props_junk/PropaneCanister001a.mdl",
    "models/props_junk/CinderBlock01a.mdl",
    "models/props_wasteland/light_spotlight01_lamp.mdl",
    "models/props_interiors/pot02a.mdl",
    "models/props_junk/GlassBottle01a.mdl",
    // "models/props_junk/glassjug01.mdl",
    "models/props_junk/garbage_glassbottle003a.mdl",
    "models/props_junk/sawblade001a.mdl",
    "models/props_junk/Shoe001a.mdl"
}

local useTimeouts = {}
local button = 8192 -- Space 2, R - 8192

local owner = owner()

local onlyOwner = true
local disableForOwner = false

local invisibleProps = false

hook.add("KeyPress", "MagicBottles", function(ply, key)
    if disableForOwner and (ply == owner) then
        return
    end

    if onlyOwner and (ply != owner) then
        return
    end

    if (button != nil) and (button != key) then
        return
    end

    if ply:isAlive() and not ply:inVehicle() then
        local time = timer.curtime()
        if ((useTimeouts[ply] or 0) < time) then
            local ent = prop.create(ply:getEyePos() + ply:getEyeAngles():getForward() * 50, ply:getEyeAngles(), table.random(model_list))
            ent:setNoDraw(invisibleProps)

            local phys = ent:getPhysicsObject()
            if isValid(phys) then
                phys:wake()
                phys:enableMotion(true)
        
                phys:addGameFlags(FVPHYSICS.DMG_DISSOLVE)
                phys:applyForceCenter(ply:getEyeAngles():getForward() * phys:getMass() * 100000)
            end

            ent:addCollisionListener(function(data, self)
                if isValid(ent) then
                    ent:remove()
                end
            end)

            useTimeouts[ply] = time + prop.spawnRate() / 10
        end
    end
end)